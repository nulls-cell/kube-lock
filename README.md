# kube-lock

## 使用场景
在k8s中部署服务经常是多副本的，在特定的场景下，多个副本之间对于同一件事情的处理是有竞争关系的，
为了解决这个问题，开发此项目，当需要修改特定资源时，可以给资源进行上锁操作，此时其他实例获取锁失败，
可以避免对同一资源的并发操作。

## 原理
主要借鉴了k8s leader election的部分逻辑，利用k8s中对于同一资源并发进行get之后update时，
只有某一个client能操作成功。同时，利用了lease类型资源可以记录锁的id和过期时间的特性，
完成了分布式锁功能的开发。

## 使用方式
参考 pkg/lock_test.go文件

## 粒度说明
### host lock
只要主机的host name相同，在非并发抢锁的情况下，所有client都能抢到锁
### process lock
每个进程使用同一把锁，进程中的所有lock可以同时获取锁，这个最接近多个pod抢锁的场景
### instance lock
每个lock实例是一把锁，同一个实例能抢到锁，不同的实例不能抢到锁